<!--
## CHANGELOG

### 0.0.x (Claude & Mochuelo-kun)
  - Initial PoC with React as a wrapper around OpenLayers that turned out to be unnecessarily complicated and headachey
  - A bunch of mistakes with Git LFS before realizing S3 was the way to go for COG GeoTIFF storage
  - Successful PoC deployment to Github Pages (frontend) + S3 (GeoTIFF and config/manifest hosting)

### 0.1.0 (GPT 5)
  - GPT 5 crushes it with a total overhaul refactor that rips out React and slims us down to a single <500 line html+css+js one shot (and faster, smoother, less buggy)

#### 0.1.1 (GPT 5)
  - Modes & clear UI: added Select, Modify, and Draw (Point/Line/Polygon) with an active button state. ‚ÄúStop‚Äù drops you back to Select. Delete button auto-enables when something‚Äôs selected.
  - No overlap with OL controls: shifted the features panel down a bit (top: 4.5rem) and added a simple active style for buttons.
  - Mobile-friendly info panel: replaced the hover coords with a click-based info panel (dismissable).
  - Click on empty map ‚Üí drops a small temporary marker and shows lat, lon.
  - Click on a feature ‚Üí centers a marker on it and shows GeoJSON properties (everything except geometry) + the feature‚Äôs center coords.

#### 0.1.2 (Mochuelo-kun)
  - Add CHANGELOG
  - Change title
  - Fix minor bugs: explicitly load GeoTIFF lib before OL, var cleanup

#### 0.1.3 (GPT 5)
  - First pass at moving some features to a collapsible side menu
  - Support LineStrings in draw mode
  - Starting to treat select|modify|draw and point|linestring|polygon as separate button groups

#### 0.1.4 (GPT 5)
  - Use Bootstrap for non-map interactive elements

#### 0.1.5 (GPT 5)
  - Consolidate add/draw controls in top menu

#### 0.1.6 (Mochuelo-kun)
  - Cleanup

-->

<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Dinacon - Coral Reef Map ‚Äì Les Village</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
        <style>
            html,
            body {
                height: 100%;
                margin: 0;
            }
            #app {
                height: 100%;
                width: 100%;
                position: relative;
            }
            #map {
                height: 100%;
                width: 100%;
            }

            /* UI chrome */
            .panel {
                position: absolute;
                z-index: 1000;
                background: rgba(255, 255, 255, 0.95);
                color: #222;
                border: 1px solid #ccc;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            }
            .panel h3 {
                margin: 0 0 8px 0;
                font-size: 14px;
            }

            /* Search bar */
            #searchPanel {
                position: absolute;
                left: 50%;
                top: 0.75rem;
                transform: translateX(-50%);
                width: min(720px, calc(100% - 1.5rem));
                z-index: 1001;
            }
            #searchBox {
                width: 100%;
                box-sizing: border-box;
                padding: 10px 12px;
                border-radius: 10px;
                border: 1px solid #bbb;
                background: rgba(255, 255, 255, 0.98);
                font-size: 14px;
            }
            #searchResults {
                position: absolute;
                left: 0;
                right: 0;
                margin-top: 6px;
                background: rgba(255, 255, 255, 0.98);
                border: 1px solid #ccc;
                border-radius: 8px;
                overflow: hidden;
                display: none;
            }
            #searchResults .item {
                padding: 8px 10px;
                cursor: pointer;
                border-bottom: 1px solid #eee;
                font-size: 14px;
            }
            #searchResults .item:last-child {
                border-bottom: 0;
            }
            #searchResults .item:hover {
                background: #f3f3f3;
            }

            /* Selected feature or location readout */
            #info {
                position: absolute;
                left: 0.75rem;
                bottom: 0.75rem;
                padding: 6px 10px;
                font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
                font-size: 12px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 6px;
                border: 1px solid #ccc;
                z-index: 1000;
            }

            @media (max-width: 640px) {
                #searchPanel {
                    left: 0.75rem;
                    right: 0.75rem;
                    transform: none;
                    width: calc(100% - 1.5rem);
                }
            }
            #modeBar {
                position: absolute;
                left: 50%;
                top: 0.75rem;
                transform: translateX(-50%);
                z-index: 902;
                display: flex;
                gap: 6px;
            }
            #modeBar .btn-group {
                background-color: #fff;
            }
        </style>
    </head>
    <body>
        <div id="app">
            <div id="map"></div>

            <div
                id="modeBar"
                class="position-absolute start-50 translate-middle-x mt-2"
                role="toolbar"
                aria-label="Mode"
                style="z-index: 1102"
            >
                <div class="modeGroup btn-group" role="group" aria-label="Mode">
                    <input
                        type="radio"
                        class="btn-check"
                        name="modeTop"
                        id="modeTopSelect"
                        autocomplete="off"
                        checked
                    />
                    <label class="btn btn-outline-secondary" for="modeTopSelect">‚òùÔ∏è</label>
                    <input type="radio" class="btn-check" name="modeTop" id="modeTopEdit" autocomplete="off" />
                    <label class="btn btn-outline-secondary" for="modeTopEdit">‚úèÔ∏è</label>
                    <input type="radio" class="btn-check" name="modeTop" id="modeTopDraw" autocomplete="off" />
                    <label class="btn btn-outline-secondary" for="modeTopDraw">‚úö</label>
                </div>
                <div id="drawGroup" class="btn-group ms-2 d-none" role="group" aria-label="Draw shapes">
                    <input type="radio" class="btn-check" name="drawShape" id="drawPointTop" autocomplete="off" />
                    <label class="btn btn-outline-secondary" for="drawPointTop">‚Ä¢</label>
                    <input type="radio" class="btn-check" name="drawShape" id="drawLineTop" autocomplete="off" />
                    <label class="btn btn-outline-secondary" for="drawLineTop">‚Äî</label>
                    <input type="radio" class="btn-check" name="drawShape" id="drawPolyTop" autocomplete="off" />
                    <label class="btn btn-outline-secondary" for="drawPolyTop">‚¨†</label>
                </div>
            </div>

            <button
                class="btn btn-light border rounded-circle position-absolute top-0 end-0 m-2"
                type="button"
                data-bs-toggle="offcanvas"
                data-bs-target="#toolsOffcanvas"
                aria-controls="toolsOffcanvas"
            >
                ‚ò∞
            </button>
            <div class="offcanvas offcanvas-end" tabindex="-1" id="toolsOffcanvas" aria-labelledby="toolsLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="toolsLabel">Tools</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <details id="sec-io">
                        <summary>Load / Save</summary>
                        <div class="row g-2 mt-2">
                            <div class="col-auto">
                                <button id="saveGeojson" class="btn btn-outline-primary" disabled>
                                    üíæ Save GeoJSON
                                </button>
                            </div>
                            <div class="col-auto">
                                <label class="btn btn-outline-secondary" for="fileGeojson">üìÅ Load GeoJSON</label>
                            </div>
                            <input id="fileGeojson" type="file" accept=".geojson,.json" class="d-none" />
                            <div class="col-auto">
                                <button id="clearGeojson" class="btn btn-outline-danger" disabled>üßπ Clear all</button>
                            </div>
                        </div>
                    </details>
                    <details id="sec-search">
                        <summary>Search / Fly-to</summary>
                        <div class="mt-2">
                            <input
                                id="searchBox"
                                type="search"
                                class="form-control"
                                placeholder="Search places (Nominatim)‚Ä¶"
                                autocomplete="off"
                            />
                            <div id="searchResults" class="list-group mt-2" style="display: none"></div>
                        </div>
                    </details>
                    <details id="sec-layers" open>
                        <summary>Layers</summary>
                        <div id="layers" class="mt-2"></div>
                    </details>
                </div>
            </div>

            <!-- removed in favor of unified Tools menu -->

            <div id="info" class="panel" style="left: 0.75rem; bottom: 0.75rem; display: none; padding: 0.5rem 0.75rem">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 0.5rem">
                    <strong>Info</strong>
                    <button
                        id="infoClose"
                        title="Close"
                        style="
                            border: 1px solid #bbb;
                            background: #fff;
                            border-radius: 6px;
                            cursor: pointer;
                            padding: 2px 6px;
                        "
                    >
                        √ó
                    </button>
                </div>
                <div
                    id="infoBody"
                    style="margin-top: 0.5rem; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px"
                ></div>
            </div>
        </div>

        <!-- OpenLayers GeoTIFF features need geotiff library loaded first -->
        <script src="https://cdn.jsdelivr.net/npm/geotiff"></script>
        <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // ---- Minimal state -------------------------------------------------------
            const state = {
                manifestUrl: 'https://dinamap-les.s3.ap-southeast-1.amazonaws.com/metadata/layers_202507200627.json',
                layersConfig: [],
                layersById: new Map(),
                features: { type: 'FeatureCollection', features: [] },
            }

            // ---- Map init ------------------------------------------------------------
            const map = new ol.Map({
                target: 'map',
                layers: [],
                view: new ol.View({
                    center: ol.proj.fromLonLat([115.367526, -8.129998]),
                    zoom: 18,
                }),
                controls: ol.control.defaults.defaults().extend([
                    new ol.control.ScaleLine({
                        units: 'metric',
                        bar: true,
                        steps: 6,
                        minWidth: 180,
                    }),
                ]),
            })

            // Coordinate/feature info on click (mobile-friendly)
            const infoEl = document.getElementById('info')
            const infoBody = document.getElementById('infoBody')
            const infoClose = document.getElementById('infoClose')
            infoClose.addEventListener('click', () => {
                infoEl.style.display = 'none'
                tempSource && tempSource.clear()
            })

            function fmtLatLon(coord3857) {
                const [lon, lat] = ol.proj.toLonLat(coord3857)
                return `${lat.toFixed(6)}, ${lon.toFixed(6)}`
            }
            function featureCenter(feat) {
                const g = feat.getGeometry()
                const t = g.getType()
                if (t === 'Point') return g.getCoordinates()
                if (t === 'LineString') return g.getCoordinateAt(0.5)
                if (t === 'Polygon') return g.getInteriorPoint().getCoordinates()
                try {
                    return ol.extent.getCenter(g.getExtent())
                } catch (e) {
                    return g.getFirstCoordinate()
                }
            }

            map.on('singleclick', (evt) => {
                const hit = map.forEachFeatureAtPixel(evt.pixel, (f) => f, {
                    layerFilter: (l) => l === featureLayer,
                })
                tempSource.clear()
                let html = ''
                const isSelectMode = mode === 'browse'
                if (!isSelectMode) return
                if (hit) {
                    const center = featureCenter(hit)
                    const props = { ...hit.getProperties() }
                    delete props.geometry
                    const propsHtml = Object.keys(props).length
                        ? Object.entries(props)
                              .map(([k, v]) => `<div><b>${k}</b>: ${String(v)}</div>`)
                              .join('')
                        : '<em>No properties</em>'
                    html = `<div>Center: ${fmtLatLon(center)}</div>` + propsHtml
                } else {
                    tempSource.addFeature(new ol.Feature(new ol.geom.Point(evt.coordinate)))
                    html = `Coords: ${fmtLatLon(evt.coordinate)}`
                }
                infoBody.innerHTML = html
                infoEl.style.display = 'block'
            })

            // ---- Feature layer & interactions ---------------------------------------
            const featureSource = new ol.source.Vector()
            const selectInteraction = new ol.interaction.Select({
                layers: undefined,
            })
            const modifyInteraction = new ol.interaction.Modify({
                source: featureSource,
            })
            modifyInteraction.setActive(false)

            const featureLayer = new ol.layer.Vector({
                source: featureSource,
                style: (feat) => {
                    const geom = feat.getGeometry()
                    if (geom.getType() === 'Point') {
                        return new ol.style.Style({
                            image: new ol.style.Circle({
                                radius: 6,
                                fill: new ol.style.Fill({ color: '#ffffff' }),
                                stroke: new ol.style.Stroke({
                                    color: '#000',
                                    width: 2,
                                }),
                            }),
                        })
                        new ol.style.Style({
                            text: new ol.style.Text({
                                text: '‚åñ',
                                font: 'bold 24px sans-serif',
                                fill: new ol.style.Fill({ color: '#ffff00' }),
                                stroke: new ol.style.Stroke({
                                    color: '#000',
                                    width: 3,
                                }),
                            }),
                        })
                    }
                    return new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: '#ffff00',
                            width: 2,
                        }),
                        fill: new ol.style.Fill({ color: 'rgba(0,0,0,0)' }),
                    })
                },
                zIndex: 1000,
            })

            map.addLayer(featureLayer)
            // Temporary marker layer for clicks/highlights
            const tempSource = new ol.source.Vector()
            const tempLayer = new ol.layer.Vector({
                source: tempSource,
                style: new ol.style.Style({
                    text: new ol.style.Text({
                        text: '‚åñ',
                        font: 'bold 24px sans-serif',
                        fill: new ol.style.Fill({ color: '#ffffff' }),
                        stroke: new ol.style.Stroke({
                            color: '#000',
                            width: 3,
                        }),
                    }),
                }),
                zIndex: 1100,
            })
            map.addLayer(tempLayer)
            map.addInteraction(selectInteraction)
            map.addInteraction(modifyInteraction)

            // Keep state.features in sync with the vector source
            const gjFmt = new ol.format.GeoJSON()
            function refreshStateFromSource() {
                const fc = gjFmt.writeFeaturesObject(featureSource.getFeatures(), {
                    dataProjection: 'EPSG:4326',
                    featureProjection: 'EPSG:3857',
                })
                state.features = fc
                syncFeatureButtons()
            }
            featureSource.on('addfeature', refreshStateFromSource)
            featureSource.on('changefeature', refreshStateFromSource)
            featureSource.on('removefeature', refreshStateFromSource)

            // Mode + drawing controls
            let mode = 'browse'

            let drawInteraction = null
            function startDraw(type) {
                if (drawInteraction) map.removeInteraction(drawInteraction)
                drawInteraction = new ol.interaction.Draw({
                    source: featureSource,
                    type,
                })
                map.addInteraction(drawInteraction)
                drawInteraction.on('drawend', () => setTimeout(refreshStateFromSource, 0))
            }
            function stopDraw() {
                if (drawInteraction) {
                    map.removeInteraction(drawInteraction)
                    drawInteraction = null
                }
            }

            function setMode(next) {
                mode = next
                const isModify = mode === 'modify'
                const isDraw = typeof mode === 'string' && mode.startsWith('draw:')
                selectInteraction.setActive(!isDraw || isModify)
                modifyInteraction.setActive(isModify)
                stopDraw()
                if (isDraw) startDraw(mode.split(':')[1])
                if (typeof syncTopMode === 'function') syncTopMode()
                if (typeof updateDeleteBtn === 'function') updateDeleteBtn()
            }

            // Top mode & draw radio groups (Bootstrap)
            const modeTopSelect = document.getElementById('modeTopSelect')
            const modeTopEdit = document.getElementById('modeTopEdit')
            const modeTopDraw = document.getElementById('modeTopDraw')
            const drawGroup = document.getElementById('drawGroup')
            const drawPointTop = document.getElementById('drawPointTop')
            const drawLineTop = document.getElementById('drawLineTop')
            const drawPolyTop = document.getElementById('drawPolyTop')
            let lastDrawShape = 'Point'

            modeTopSelect.addEventListener('change', () => setMode('browse'))
            modeTopEdit.addEventListener('change', () => setMode('modify'))
            modeTopDraw.addEventListener('change', () => setMode(`draw:${lastDrawShape}`))
            drawPointTop.addEventListener('change', () => {
                lastDrawShape = 'Point'
                setMode('draw:Point')
            })
            drawLineTop.addEventListener('change', () => {
                lastDrawShape = 'LineString'
                setMode('draw:LineString')
            })
            drawPolyTop.addEventListener('change', () => {
                lastDrawShape = 'Polygon'
                setMode('draw:Polygon')
            })

            function syncTopMode() {
                const isDraw = typeof mode === 'string' && mode.startsWith('draw:')
                modeTopSelect.checked = mode === 'browse'
                modeTopEdit.checked = mode === 'modify'
                modeTopDraw.checked = isDraw
                drawGroup.classList.toggle('d-none', !isDraw)
                if (isDraw) {
                    const shape = mode.split(':')[1]
                    drawPointTop.checked = shape === 'Point'
                    drawLineTop.checked = shape === 'LineString'
                    drawPolyTop.checked = shape === 'Polygon'
                } else {
                    drawPointTop.checked = drawLineTop.checked = drawPolyTop.checked = false
                }
            }

            // Delete selected features
            // TODO: re-add a delete button as part of edit mode
            const deleteBtn = document.getElementById('deleteSelected')
            if (deleteBtn) {
                selectInteraction.on('select', () => {
                    deleteBtn.disabled = selectInteraction.getFeatures().getLength() === 0
                })
                deleteBtn.onclick = () => {
                    const sel = selectInteraction.getFeatures()
                    sel.getArray().forEach((f) => featureSource.removeFeature(f))
                    sel.clear()
                }
            }

            // Keyboard delete
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Delete' || (e.key === 'Backspace' && (e.ctrlKey || e.metaKey))) {
                    const sel = selectInteraction.getFeatures()
                    if (sel.getLength()) {
                        sel.getArray().forEach((f) => featureSource.removeFeature(f))
                        sel.clear()
                        e.preventDefault()
                    }
                }
            })

            function updateDeleteBtn() {
                if (!deleteBtn) return
                deleteBtn.disabled = !(
                    selectInteraction.getFeatures().getLength() > 0 &&
                    (mode === 'browse' || mode === 'modify')
                )
            }
            selectInteraction.on('select', updateDeleteBtn)
            setMode('browse')

            function syncFeatureButtons() {
                const has = state.features.features.length > 0
                document.getElementById('saveGeojson').disabled = !has
                document.getElementById('clearGeojson').disabled = !has
            }

            function setFeaturesFromGeoJSON(geojson) {
                state.features =
                    geojson && geojson.type === 'FeatureCollection'
                        ? geojson
                        : { type: 'FeatureCollection', features: [] }
                featureSource.clear()
                if (state.features.features.length) {
                    const feats = gjFmt.readFeatures(state.features, {
                        dataProjection: 'EPSG:4326',
                        featureProjection: 'EPSG:3857',
                    })
                    featureSource.addFeatures(feats)
                }
                syncFeatureButtons()
            }

            // ---- GeoJSON I/O ---------------------------------------------------------
            document.getElementById('saveGeojson').addEventListener('click', () => {
                const blob = new Blob([JSON.stringify(state.features, null, 2)], {
                    type: 'application/json',
                })
                const a = document.createElement('a')
                a.href = URL.createObjectURL(blob)
                a.download = `features-${new Date().toISOString().slice(0, 10)}.geojson`
                a.click()
                URL.revokeObjectURL(a.href)
            })
            document.getElementById('fileGeojson').addEventListener('change', (e) => {
                const file = e.target.files[0]
                if (!file) return
                const reader = new FileReader()
                reader.onload = () => {
                    try {
                        const geojson = JSON.parse(reader.result)
                        if (geojson.type !== 'FeatureCollection')
                            throw new Error('File must be a GeoJSON FeatureCollection')
                        setFeaturesFromGeoJSON(geojson)
                    } catch (err) {
                        alert('Error loading GeoJSON: ' + err.message)
                    }
                    e.target.value = ''
                }
                reader.readAsText(file)
            })
            document.getElementById('clearGeojson').addEventListener('click', () => {
                if (!state.features.features.length) return
                if (confirm(`Remove all ${state.features.features.length} features?`))
                    setFeaturesFromGeoJSON({
                        type: 'FeatureCollection',
                        features: [],
                    })
            })

            // ---- Layers manifest (COGs + basemaps) ----------------------------------
            async function loadManifest() {
                try {
                    const res = await fetch(state.manifestUrl, {
                        cache: 'no-store',
                    })
                    if (!res.ok) throw new Error('HTTP ' + res.status)
                    const json = await res.json()
                    state.layersConfig = json.layers || []
                } catch (e) {
                    console.warn('Manifest load failed, using inline sample:', e)
                    // Fallback minimal example
                    state.layersConfig = [
                        {
                            id: 'osm',
                            type: 'osm',
                            label: 'OpenStreetMap',
                            visible: true,
                        },
                    ]
                }
            }

            function buildLayer(cfg) {
                const { type, url, attributionText, attributionUrl, maxZoom, visible } = cfg
                if (type === 'osm') {
                    return new ol.layer.Tile({
                        visible,
                        source: new ol.source.OSM(),
                    })
                }
                if (type === 'satellite') {
                    return new ol.layer.Tile({
                        visible,
                        source: new ol.source.XYZ({
                            url,
                            attributions:
                                attributionText && attributionUrl
                                    ? `Tiles ¬© <a href="${attributionUrl}">${attributionText}</a>`
                                    : attributionText || '',
                            maxZoom,
                        }),
                    })
                }
                if (type === 'geotiff') {
                    return new ol.layer.WebGLTile({
                        visible,
                        source: new ol.source.GeoTIFF({
                            sources: [{ url }],
                            attributions: attributionText || '',
                        }),
                    })
                }
                console.warn('Unknown layer type:', type)
                return null
            }

            function renderLayerToggles() {
                const container = document.getElementById('layers')
                container.innerHTML = ''
                state.layersConfig.forEach((cfg) => {
                    const id = `layer_${cfg.id}`
                    const wrapper = document.createElement('div')
                    wrapper.className = 'form-check form-switch'
                    const input = document.createElement('input')
                    input.type = 'checkbox'
                    input.className = 'form-check-input'
                    input.id = id
                    input.checked = !!cfg.visible
                    const label = document.createElement('label')
                    label.className = 'form-check-label'
                    label.htmlFor = id
                    label.textContent = cfg.label || cfg.id
                    input.addEventListener('change', () => {
                        const layer = state.layersById.get(cfg.id)
                        if (layer) layer.setVisible(input.checked)
                    })
                    wrapper.appendChild(input)
                    wrapper.appendChild(label)
                    container.appendChild(wrapper)
                })
            }

            function applyLayers() {
                // Remove previous non-feature layers
                map.getLayers()
                    .getArray()
                    .slice()
                    .forEach((lyr) => {
                        if (lyr !== featureLayer && lyr !== tempLayer) map.removeLayer(lyr)
                    })
                state.layersById.clear()
                state.layersConfig.forEach((cfg) => {
                    const layer = buildLayer(cfg)
                    if (layer) {
                        map.getLayers().insertAt(map.getLayers().getLength() - 0, layer) // keep featureLayer on top
                        state.layersById.set(cfg.id, layer)
                    }
                })
                renderLayerToggles()
            }

            ;(async function init() {
                await loadManifest()
                applyLayers()
                setFeaturesFromGeoJSON({
                    type: 'FeatureCollection',
                    features: [],
                })
            })()

            // ---- Nominatim search ----------------------------------------------------
            const searchInput = document.getElementById('searchBox')
            const searchResults = document.getElementById('searchResults')

            function debounce(fn, ms) {
                let t
                return (...args) => {
                    clearTimeout(t)
                    t = setTimeout(() => fn(...args), ms)
                }
            }

            async function geocode(q) {
                const url = `https://nominatim.openstreetmap.org/search?format=json&limit=6&q=${encodeURIComponent(q)}`
                const res = await fetch(url, {
                    headers: { 'Accept-Language': navigator.language || 'en' },
                })
                if (!res.ok) throw new Error('Geocoding failed')
                return res.json()
            }

            function showResults(items) {
                searchResults.innerHTML = ''
                if (!items || !items.length) {
                    searchResults.style.display = 'none'
                    return
                }
                items.forEach((item) => {
                    const btn = document.createElement('button')
                    btn.type = 'button'
                    btn.className = 'list-group-item list-group-item-action'
                    btn.textContent = item.display_name
                    btn.addEventListener('click', () => {
                        const lat = parseFloat(item.lat),
                            lon = parseFloat(item.lon)
                        flyTo(lat, lon, 15)
                        searchResults.style.display = 'none'
                    })
                    searchResults.appendChild(btn)
                })
                searchResults.style.display = 'block'
            }

            const doSearch = debounce(async () => {
                const q = searchInput.value.trim()
                if (q.length < 3) {
                    searchResults.style.display = 'none'
                    return
                }
                try {
                    showResults(await geocode(q))
                } catch (e) {
                    console.warn(e)
                    searchResults.style.display = 'none'
                }
            }, 400)

            searchInput.addEventListener('input', doSearch)
            document.addEventListener('click', (e) => {
                if (!document.getElementById('sec-search').contains(e.target)) searchResults.style.display = 'none'
            })

            // Optional: expose a helper to fly to a lat/lon
            function flyTo(lat, lon, zoom = 13) {
                map.getView().animate(
                    { zoom: 7, duration: 250 },
                    { center: ol.proj.fromLonLat([lon, lat]), duration: 650 },
                    { zoom, duration: 300 }
                )
            }
            window.flyTo = flyTo
        </script>
    </body>
</html>
